{% extends 'base.html' %}

{% block title %}Admin Panel - Manage Reviews{% endblock %}

{% block content %}
<div class="admin-container">
    <h2 style="margin-bottom: 1.2rem;">üõ†Ô∏è Admin Review Panel</h2>

    {% if reviews and reviews|length > 0 %}
        {% for review in reviews %}
        <div class="review admin-review">
            <div class="review-header" style="gap:18px;">
                <span class="review-productid"><b>Product ID:</b> {{ review['product_id'] }}</span>
                <span class="review-rating">
                    {% for i in range(1, 6) %}
                        {% if i <= review['rating']|int %}
                        <span class="star">&#9733;</span>
                        {% else %}
                        <span class="star inactive">&#9733;</span>
                        {% endif %}
                    {% endfor %}
                </span>
                <span>
                  {% if review['approved'] %}
                    <span class="verified-badge" style="background:#e0f7e9; color:#21b87a;">Approved</span>
                  {% elif review['rejected'] %}
                    <span class="verified-badge" style="background:#ffebeb; color:#db4437;">Rejected</span>
                  {% else %}
                    <span class="verified-badge" style="background:#fff5d7; color:#de9200;">Pending</span>
                  {% endif %}
                </span>
            </div>
            <div class="review-info" style="margin-bottom:7px;">
                <b>Name:</b> {{ review['name'] }}<br>
                <b>Review:</b> {{ review['text'] or review['message'] }}<br>
                {% if review.get('image_url') %}
                  <img src="{{ review['image_url'] }}" alt="User Product Pic" class="review-img" style="margin:7px 0;">
                {% endif %}
                {% if review.get('admin_reply') %}
                  <div style="background:#f7fafd;padding:8px 14px;border-radius:7px;margin:7px 0 0 0;">
                    <b>Admin Reply:</b> {{ review['admin_reply'] }}
                  </div>
                {% endif %}
            </div>
            <div class="review-actions" style="display:flex;gap:12px;flex-wrap:wrap;">

                <!-- Approve -->
                {% if not review['approved'] and not review['rejected'] %}
                <form method="POST" action="/admin/approve/{{ review['_id'] }}">
                    <button type="submit" class="submit-btn" style="background:#43a047;">Approve</button>
                </form>
                <!-- Reject -->
                <form method="POST" action="/admin/reject/{{ review['_id'] }}">
                    <button type="submit" class="submit-btn" style="background:#db4437;">Reject</button>
                </form>
                {% endif %}

                <!-- Edit/Amend -->
                <button class="submit-btn" style="background:#f5b942;" onclick="toggleEdit('{{ review['_id'] }}')">Amend</button>

                <!-- Reply -->
                <button class="submit-btn" style="background:#3165d4;" onclick="toggleReply('{{ review['_id'] }}')">Reply</button>
            </div>
            
            <!-- Amend Review Form (Hidden by default) -->
            <form id="edit-form-{{ review['_id'] }}" class="admin-edit-form" method="POST" action="/admin/amend/{{ review['_id'] }}" style="display:none;margin-top:10px;">
                <label>Edit Review:</label>
                <textarea name="text" style="width:100%;min-height:50px;border-radius:6px;">{{ review['text'] or review['message'] }}</textarea>
                <button type="submit" class="submit-btn" style="margin-top:8px;">Save Changes</button>
            </form>

            <!-- Reply Form (Hidden by default) -->
            <form id="reply-form-{{ review['_id'] }}" class="admin-reply-form" method="POST" action="/admin/reply/{{ review['_id'] }}" style="display:none;margin-top:8px;">
                <label>Admin Reply:</label>
                <input type="text" name="reply" class="field" style="width:100%;border-radius:6px;" maxlength="240" required>
                <button type="submit" class="submit-btn" style="margin-top:7px;">Send Reply</button>
            </form>
        </div>
        {% endfor %}
    {% else %}
        <div style="padding:2rem 0;font-size:1.1rem;color:#888;">No reviews found.</div>
    {% endif %}
</div>

<script>
function toggleEdit(id) {
    var form = document.getElementById('edit-form-' + id);
    if (form.style.display === "none") form.style.display = "block";
    else form.style.display = "none";
}
function toggleReply(id) {
    var form = document.getElementById('reply-form-' + id);
    if (form.style.display === "none") form.style.display = "block";
    else form.style.display = "none";
}
</script>
{% endblock %}
