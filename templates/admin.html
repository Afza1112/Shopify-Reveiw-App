{% extends 'base.html' %}
{% block title %}Admin Panel - Manage Reviews{% endblock %}

{% block content %}
<div class="admin-dashboard">
  <!-- SIDEBAR -->
  <div class="admin-sidebar">
    <div class="logo-bar" style="padding: 20px 0 16px 0; text-align:center;">
  <img src="{{ url_for('static', filename='Logo.png') }}" alt="Logo" class="site-logo" style="max-width:110px;">
</div>

    <h2>Admin</h2>
    <nav class="admin-nav">
      <ul>
        <li><a href="{{ url_for('admin.admin_panel') }}" class="{% if not show_all %}active{% endif %}">Pending Reviews</a></li>
        <li><a href="{{ url_for('admin.all_reviews') }}" class="{% if show_all %}active{% endif %}">All Reviews</a></li>
        <li><a href="#">Accounts</a></li>
        <li><a href="#">Settings</a></li>
      </ul>
    </nav>
    <div class="sidebar-footer">Paksa Review System<br>Version 2.1.0</div>
</div>

  <!-- MAIN PANEL -->
  <div class="admin-main">
    <div class="admin-header">
      <span class="admin-title">Reviews</span>
      <div class="admin-actions">
        <input type="text" placeholder="Search review..." id="review-search" class="admin-search-input" style="padding:7px 14px;border-radius:6px;border:1px solid #e3e7f2;">
        <!-- Example import/export:
        <button class="admin-btn">Import</button>
        <button class="admin-btn">Export</button>
        -->
      </div>
    </div>

    <!-- Flash Messages (optional) -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, msg in messages %}
          <div class="flash-message {{ category }}">{{ msg }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="admin-table-container">
      <table class="admin-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Product ID</th>
            <th>Content</th>
            <th>Rating</th>
            <th>Status</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
        {% if reviews %}
          {% for review in reviews %}
            <tr>
              <td>
                <span class="admin-avatar">{{ review.name[0]|upper if review.name else "U" }}</span>
                {{ review.name or "Unknown" }}
              </td>
              <td>{{ review.product_id }}</td>
              <td>
                {{ review.text or review.message }}
                {% if review.image_url %}
                  <br>
                  <img src="{{ review.image_url }}" class="review-img" alt="Review image">
                {% endif %}
                {% if review.admin_reply %}
                  <div style="margin-top:8px;color:#1ca56c;font-size:.98rem;">
                    <b>Reply:</b> {{ review.admin_reply }}
                  </div>
                {% endif %}
              </td>
              <td>
                <span class="stars">
                  {% for i in range(1,6) %}
                    {% if i <= (review.rating|int) %}
                      &#9733;
                    {% else %}
                      <span style="color:#ccc">&#9733;</span>
                    {% endif %}
                  {% endfor %}
                </span>
              </td>
              <td>
                {% if review.approved %}
                  <span class="admin-badge">Approved</span>
                {% elif review.rejected %}
                  <span class="admin-badge rejected">Rejected</span>
                {% else %}
                  <span class="admin-badge pending">Pending</span>
                {% endif %}
              </td>
              <td>
                {% if review.created_at %}
                  {{ review.created_at|datetimeformat }}
                {% else %}
                  --
                {% endif %}
              </td>
              <td>
                <div class="admin-actions-list">
                  {% if not review.approved and not review.rejected %}
                    <form method="POST" action="{{ url_for('admin.approve_review', review_id=review._id) }}">
                      <button type="submit" class="admin-action-link">Approve</button>
                    </form>
                    <form method="POST" action="{{ url_for('admin.reject_review', review_id=review._id) }}">
                      <button type="submit" class="admin-action-link" style="color:#e33d2e;">Reject</button>
                    </form>
                  {% endif %}
                  <!-- Amend/Reply modal triggers (could be modals, or link to a page) -->
                  <a href="#" class="admin-action-link" onclick="openAmendModal('{{ review._id }}', {{ (review.text or review.message)|tojson }});return false;">Amend</a>

                  <a href="#" class="admin-action-link reply" onclick="openReplyModal('{{ review._id }}');return false;">Reply</a>
                  <form method="POST" action="{{ url_for('admin.delete_review_admin', review_id=review._id) }}" onsubmit="return confirm('Delete this review?');">
                    <button type="submit" class="admin-action-link delete">Delete</button>
                  </form>
                </div>
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="7" style="text-align:center;color:#888;">No reviews found.</td>
          </tr>
        {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Optional: Modal for amend/reply (JS required to show/hide) -->
<div id="amend-modal" class="modal" style="display:none;">
  <div class="modal-content">
    <form id="amend-form" method="POST">
      <h3>Amend Review</h3>
      <textarea name="amend_text" id="amend_text" style="width:100%;height:80px;" required></textarea>
      <button type="submit" class="admin-btn" style="margin-top:10px;">Save</button>
      <button type="button" class="admin-btn" style="background:#eee;color:#333;margin-left:7px;" onclick="closeAmendModal()">Cancel</button>
    </form>
  </div>
</div>
<div id="reply-modal" class="modal" style="display:none;">
  <div class="modal-content">
    <form id="reply-form" method="POST">
      <h3>Reply to Review</h3>
      <textarea name="reply_text" id="reply_text" style="width:100%;height:80px;" required></textarea>
      <button type="submit" class="admin-btn" style="margin-top:10px;">Send Reply</button>
      <button type="button" class="admin-btn" style="background:#eee;color:#333;margin-left:7px;" onclick="closeReplyModal()">Cancel</button>
    </form>
  </div>
</div>

<script>
// Modal handlers (basic, for demo - improve as needed)
let amendModal = document.getElementById('amend-modal');
let replyModal = document.getElementById('reply-modal');
let amendForm = document.getElementById('amend-form');
let replyForm = document.getElementById('reply-form');
let currentReviewId = '';

function openAmendModal(reviewId, text) {
  amendModal.style.display = 'flex';
  amendForm.action = '/admin/amend/' + reviewId;
  document.getElementById('amend_text').value = text || '';
}
function closeAmendModal() {
  amendModal.style.display = 'none';
  amendForm.action = '';
}
function openReplyModal(reviewId) {
  replyModal.style.display = 'flex';
  replyForm.action = '/admin/reply/' + reviewId;
  document.getElementById('reply_text').value = '';
}
function closeReplyModal() {
  replyModal.style.display = 'none';
  replyForm.action = '';
}
window.onclick = function(event) {
  if(event.target === amendModal) closeAmendModal();
  if(event.target === replyModal) closeReplyModal();
}
</script>
{% endblock %}
