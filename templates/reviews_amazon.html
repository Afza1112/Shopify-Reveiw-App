{% extends "base.html" %}
{% block content %}
<div class="amazon-reviews-box">
    <h2>Customer reviews</h2>
    <div class="review-product-box">
    <h2>Review this product</h2>
    <p>Share your thoughts with other customers</p>
    <button class="amazon-review-btn" onclick="document.getElementById('review-modal').style.display='block'">
        Write a customer review
    </button>
</div>

<!-- Review Modal -->
<div id="review-modal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close" onclick="document.getElementById('review-modal').style.display='none'">&times;</span>
    <form id="review-form" enctype="multipart/form-data">
        <label>Name:</label>
        <input type="text" name="name" required><br>
        <label>Rating:</label>
        <select name="rating" required>
            <option value="">Select...</option>
            {% for i in range(5,0,-1) %}
                <option value="{{ i }}">{{ i }} star</option>
            {% endfor %}
        </select><br>
        <label>Review:</label>
        <textarea name="text" required></textarea><br>
        <label>Photo (optional):</label>
        <input type="file" name="image"><br>
        <button type="submit">Submit</button>
    </form>
    <div id="review-msg"></div>
  </div>
</div>

    <div class="amazon-summary">
        <span style="font-size:2rem;">{{ avg_rating }} out of 5</span>
        <span class="star-bar">
            {% for i in range(1,6) %}
                {% if i <= avg_rating|round(0, 'floor') %}
                    <span style="color:orange;">&#9733;</span>
                {% else %}
                    <span style="color:#ddd;">&#9733;</span>
                {% endif %}
            {% endfor %}
        </span>
        <div>{{ total_reviews }} global ratings</div>
    </div>
    <div class="star-breakdown">
        {% for i in range(5, 0, -1) %}
            <div>
                <span>{{ i }} star</span>
                <div class="star-bar-bg">
                    <div class="star-bar-fill" style="width:{{ star_perc[i] }}%"></div>
                </div>
                <span>{{ star_perc[i] }}%</span>
            </div>
        {% endfor %}
    </div>
    <h3>Reviews with images</h3>
    <div class="amazon-images-row">
        {% for review in reviews if review.image_url %}
            <img src="{{ review.image_url }}" alt="review image" style="width:120px;height:120px;object-fit:cover;margin:6px;">
        {% endfor %}
    </div>
    <h3>All Reviews</h3>
    {% for review in reviews %}
        <div class="review-item">
            <div><strong>{{ review.name or "Anonymous" }}</strong>
                <span class="star-bar">
                {% for i in range(1,6) %}
                    {% if i <= review.rating|int %}
                        <span style="color:orange;">&#9733;</span>
                    {% else %}
                        <span style="color:#ddd;">&#9733;</span>
                    {% endif %}
                {% endfor %}
                </span>
            </div>
            <div>{{ review.text }}</div>
            {% if review.image_url %}
                <img src="{{ review.image_url }}" alt="review image" style="width:80px;">
            {% endif %}
        </div>
    {% endfor %}
</div>
{% endblock %}

<script>
document.getElementById('review-form').onsubmit = async function(e) {
    e.preventDefault();
    var formData = new FormData(this);
    const res = await fetch('/api/review', {
        method: 'POST',
        body: formData
    });
    const data = await res.json();
    document.getElementById('review-msg').innerText = data.message || "Submitted!";
    if(data.message && data.message.includes("pending")) {
        setTimeout(() => {
            document.getElementById('review-modal').style.display='none';
            location.reload();
        }, 1800);
    }
};
</script>
