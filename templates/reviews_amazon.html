{% extends "base.html" %}
{% block content %}
<div class="amazon-page">
  <div class="amazon-columns">

    <!-- LEFT PANEL -->
    <div class="left-panel">
      <h2 style="margin-bottom: .5rem;">Customer reviews</h2>
      <div class="rating-summary">
        <span class="stars" style="color: #ff9900; font-size:2rem;">
          {% for i in range(1,6) %}
            {% if i <= avg_rating|round(0, 'floor') %}
              &#9733;
            {% else %}
              <span style="color:#ddd">&#9733;</span>
            {% endif %}
          {% endfor %}
        </span>
        <span style="font-size: 1.35rem; font-weight:500; margin-left: 5px;">{{ avg_rating or 0 }} out of 5</span>
      </div>
      <div class="ratings-bar">
        <div style="font-size:.98rem; color:#555; margin-bottom:2px;">{{ total_reviews or 0 }} global ratings</div>
        {% for i in range(5,0,-1) %}
          <div class="star-row">
            <span>{{ i }} star</span>
            <div class="bar-bg">
              <div class="bar-fill" style="width:{{ star_perc[i]|default(0) }}%"></div>
            </div>
            <span>{{ star_perc[i]|default(0) }}%</span>
          </div>
        {% endfor %}
      </div>
      <div class="review-this-product">
        <h3 style="margin-top: 1.6rem; margin-bottom: 0.3rem;">Review this product</h3>
        <div style="color:#333; font-size:1rem;">Share your thoughts with other customers</div>
        <button class="amazon-review-btn" onclick="document.getElementById('review-modal').style.display='flex'">
          Write a customer review
        </button>
      </div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="right-panel">
      {% if reviews|selectattr('image_url')|list %}
      <h3 style="margin-top:0;">Reviews with images</h3>
      <div class="review-images">
        {% for review in reviews if review.image_url %}
          <img src="{{ review.image_url }}" class="review-img" alt="review image">
        {% endfor %}
      </div>
      {% endif %}

      <h3 style="margin-top:1.5rem;">Top reviews</h3>
      {% for review in reviews %}
        <div class="review-card">
          <div class="review-header">
            <div class="avatar">
              {% if review.name %}
                {{ review.name[0]|upper }}
              {% else %}
                <img src="/static/default_avatar.png" alt="User" style="width: 36px; border-radius: 50%;">
              {% endif %}
            </div>
            <div>
              <span class="review-name">{{ review.name or "Anonymous" }}</span>
              {% if review.verified %}
                <span class="verified-badge">Verified Buyer</span>
              {% endif %}
              <span class="review-stars">
                {% for i in range(1,6) %}
                  {% if i <= review.rating|int %}
                    &#9733;
                  {% else %}
                    <span style="color:#ddd">&#9733;</span>
                  {% endif %}
                {% endfor %}
              </span>
            </div>
          </div>
          <div class="review-text">{{ review.text }}</div>
          {% if review.image_url %}
            <img src="{{ review.image_url }}" class="review-card-img" alt="review image" onclick="openImgModal(this.src)">
          {% endif %}
        </div>
      {% else %}
        <div>No reviews yet.</div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- REVIEW MODAL -->
<div id="review-modal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close" onclick="document.getElementById('review-modal').style.display='none'">&times;</span>
    <form id="review-form" enctype="multipart/form-data" autocomplete="off">
      <label for="name">Your Name:</label>
      <input type="text" name="name" required maxlength="32">
      <label for="rating">Rating:</label>
      <select name="rating" required>
        <option value="">Select...</option>
        {% for i in range(5,0,-1) %}
          <option value="{{ i }}">{{ i }} star</option>
        {% endfor %}
      </select>
      <label for="text">Your Review:</label>
      <textarea name="text" required maxlength="1000"></textarea>
      <label for="image">Photo (optional):</label>
      <input type="file" name="image" accept="image/*">
      <button type="submit" class="submit-btn" style="margin-top:14px;">Submit Review</button>
    </form>
    <div id="review-msg" class="msg"></div>
  </div>
</div>

<!-- IMAGE MODAL for enlarged image -->
<div id="img-modal" class="img-modal" onclick="closeImgModal()">
  <span class="modal-close" onclick="closeImgModal()">&times;</span>
  <img id="img-modal-img" src="" alt="Review Image">
</div>

<script>
document.getElementById('review-form').onsubmit = async function(e) {
  e.preventDefault();
  var formData = new FormData(this);
  const res = await fetch('/api/review', { method: 'POST', body: formData });
  const data = await res.json();
  document.getElementById('review-msg').innerText = data.message || "Submitted!";
  if (data.message && data.message.includes("pending")) {
    setTimeout(() => {
      document.getElementById('review-modal').style.display='none';
      location.reload();
    }, 1800);
  }
};

// Image modal functionality
function openImgModal(src) {
  var modal = document.getElementById('img-modal');
  var img = document.getElementById('img-modal-img');
  img.src = src;
  modal.style.display = 'flex';
}
function closeImgModal() {
  document.getElementById('img-modal').style.display = 'none';
  document.getElementById('img-modal-img').src = '';
}
</script>
{% endblock %}
